-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.assignment_staffs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  assignment_id uuid NOT NULL,
  staff_id uuid NOT NULL,
  assigned_at timestamp with time zone DEFAULT now(),
  CONSTRAINT assignment_staffs_pkey PRIMARY KEY (id),
  CONSTRAINT assignment_staffs_assignment_id_fkey FOREIGN KEY (assignment_id) REFERENCES public.assignments(id),
  CONSTRAINT assignment_staffs_staff_id_fkey FOREIGN KEY (staff_id) REFERENCES public.users(id)
);
CREATE TABLE public.assignments (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  reservation_id uuid,
  assigned_at timestamp with time zone DEFAULT now(),
  CONSTRAINT assignments_pkey PRIMARY KEY (id),
  CONSTRAINT assignments_reservation_id_fkey FOREIGN KEY (reservation_id) REFERENCES public.reservations(id)
);

CREATE TABLE public.otp_codes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  phone text NOT NULL,
  code text NOT NULL,
  sent boolean DEFAULT false,
  expires_at timestamp with time zone NOT NULL,
  created_at timestamp with time zone DEFAULT now(),
  is_verif boolean NOT NULL DEFAULT false,
  CONSTRAINT otp_codes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.payments (
  reservation_id uuid NOT NULL,
  gross_amount numeric NOT NULL,
  payment_type text,
  transaction_status text,
  transaction_time timestamp with time zone,
  fraud_status text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  redirect_url text,
  CONSTRAINT payments_pkey PRIMARY KEY (reservation_id),
  CONSTRAINT payments_reservation_id_fkey FOREIGN KEY (reservation_id) REFERENCES public.reservations(id)
);
CREATE TABLE public.reservations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid DEFAULT auth.uid(),
  service_type_id uuid,
  location_id uuid NOT NULL,
  scheduled_datetime date,
  next_scheduled_datetime date,
  status text NOT NULL DEFAULT 'in_progress'::text CHECK (status = ANY (ARRAY['pending'::text, 'confirmed'::text, 'in_progress'::text, 'completed'::text, 'cancelled'::text])),
  contact_phone text,
  septic_tank numeric,
  schedule_slot text,
  rit real, --tidak di gunakan dlu
  customer_notes text,
  reservation_number text, --tidak di gunakan 
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT reservations_pkey PRIMARY KEY (id),
  CONSTRAINT reservationss_location_id_fkey FOREIGN KEY (location_id) REFERENCES public.user_locations(id),
  CONSTRAINT reservationss_service_type_id_fkey FOREIGN KEY (service_type_id) REFERENCES public.services(id),
  CONSTRAINT reservationss_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.schedule_slots (
  id integer NOT NULL DEFAULT nextval('schedule_slots_id_seq'::regclass),
  slot character varying NOT NULL,
  is_active boolean NOT NULL DEFAULT true,
  CONSTRAINT schedule_slots_pkey PRIMARY KEY (id)
);
CREATE TABLE public.services (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  name_service text NOT NULL,
  status text DEFAULT 'active'::text CHECK (status = ANY (ARRAY['active'::text, 'inactive'::text])),
  created_at timestamp with time zone DEFAULT now(),
  price numeric,
  CONSTRAINT services_pkey PRIMARY KEY (id)
);
CREATE TABLE public.user_locations (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  label text,
  location text, -- ini kepake yang lama adalah address
  latitude numeric,
  longitude numeric,
  created_at timestamp with time zone DEFAULT now(),
  main_address boolean DEFAULT false,
  detail_location text, -- ini ga kepake
  CONSTRAINT user_locations_pkey PRIMARY KEY (id),
  CONSTRAINT user_locations_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id)
);
CREATE TABLE public.users (
  id uuid NOT NULL DEFAULT auth.uid(),
  email text,
  name text,
  phone text UNIQUE,
  id_number text UNIQUE,
  role text NOT NULL DEFAULT 'user'::text CHECK (role = ANY (ARRAY['user'::text, 'admin'::text, 'employee'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  profile_picture text,
  notify_reservation boolean DEFAULT false,
  notify_information boolean DEFAULT false,
  is_active boolean DEFAULT true,
  password_hash text,
  CONSTRAINT users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.wa_notification_templates (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  type text NOT NULL UNIQUE,
  category USER-DEFINED NOT NULL DEFAULT 'reservation'::notification_category,
  template text NOT NULL,
  active boolean DEFAULT true,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT wa_notification_templates_pkey PRIMARY KEY (id)
);
CREATE TABLE public.wa_notifications (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  user_id uuid,
  reservation_id uuid,
  type text NOT NULL,
  status USER-DEFINED DEFAULT 'pending'::notification_status,
  created_at timestamp with time zone DEFAULT now(),
  sent_at timestamp with time zone,
  CONSTRAINT wa_notifications_pkey PRIMARY KEY (id),
  CONSTRAINT wa_notifications_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.users(id),
  CONSTRAINT wa_notifications_reservation_id_fkey FOREIGN KEY (reservation_id) REFERENCES public.reservations(id)
);